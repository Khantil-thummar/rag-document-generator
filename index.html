<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RAG Document Generator</title>
    <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #0a0a0f;
            --bg-card: #12121a;
            --bg-hover: #1a1a25;
            --accent: #00ff88;
            --accent-dim: #00cc6a;
            --text-primary: #ffffff;
            --text-secondary: #8b8b9e;
            --text-muted: #4a4a5c;
            --border: #2a2a3a;
            --danger: #ff4757;
            --warning: #ffa502;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'DM Sans', sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
            background-image: 
                radial-gradient(ellipse at 20% 0%, rgba(0, 255, 136, 0.08) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 100%, rgba(0, 255, 136, 0.05) 0%, transparent 50%);
        }

        .app {
            max-width: 1000px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: 50px;
        }

        .logo {
            font-family: 'Space Mono', monospace;
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--accent);
            margin-bottom: 8px;
            letter-spacing: -1px;
        }

        .logo span {
            color: var(--text-primary);
        }

        .tagline {
            color: var(--text-secondary);
            font-size: 1rem;
        }

        /* Grid Layout */
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            margin-bottom: 24px;
        }

        .full-width {
            grid-column: 1 / -1;
        }

        /* Cards */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 28px;
            transition: border-color 0.3s;
        }

        .card:hover {
            border-color: var(--accent-dim);
        }

        .card-title {
            font-family: 'Space Mono', monospace;
            font-size: 0.85rem;
            color: var(--accent);
            text-transform: uppercase;
            letter-spacing: 1.5px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card-title::before {
            content: '';
            width: 8px;
            height: 8px;
            background: var(--accent);
            border-radius: 50%;
            box-shadow: 0 0 10px var(--accent);
        }

        /* Upload Zone */
        .upload-zone {
            border: 2px dashed var(--border);
            border-radius: 12px;
            padding: 50px 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: transparent;
        }

        .upload-zone:hover, .upload-zone.dragover {
            border-color: var(--accent);
            background: rgba(0, 255, 136, 0.03);
        }

        .upload-icon {
            font-size: 3rem;
            margin-bottom: 15px;
            filter: grayscale(1);
            transition: filter 0.3s;
        }

        .upload-zone:hover .upload-icon {
            filter: grayscale(0);
        }

        .upload-text {
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .upload-formats {
            font-family: 'Space Mono', monospace;
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        #fileInput {
            display: none;
        }

        /* Documents List */
        .docs-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .btn-icon {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-secondary);
            padding: 8px 14px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .btn-icon:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        .doc-list {
            max-height: 280px;
            overflow-y: auto;
        }

        .doc-list::-webkit-scrollbar {
            width: 4px;
        }

        .doc-list::-webkit-scrollbar-track {
            background: var(--bg-dark);
        }

        .doc-list::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 4px;
        }

        .doc-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            background: var(--bg-dark);
            border-radius: 10px;
            margin-bottom: 10px;
            border-left: 3px solid var(--accent);
        }

        .doc-name {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 6px;
        }

        .doc-meta {
            font-size: 0.8rem;
            color: var(--text-muted);
            font-family: 'Space Mono', monospace;
        }

        .doc-id {
            color: var(--text-secondary);
            font-size: 0.75rem;
        }

        .btn-delete {
            background: transparent;
            border: 1px solid var(--danger);
            color: var(--danger);
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s;
        }

        .btn-delete:hover {
            background: var(--danger);
            color: white;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: var(--text-muted);
        }

        /* Generate Form */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 10px;
            font-weight: 500;
        }

        .form-textarea {
            width: 100%;
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 16px;
            color: var(--text-primary);
            font-size: 1rem;
            font-family: inherit;
            resize: vertical;
            min-height: 120px;
            transition: border-color 0.3s;
        }

        .form-textarea:focus {
            outline: none;
            border-color: var(--accent);
        }

        .form-textarea::placeholder {
            color: var(--text-muted);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .form-select, .form-input {
            width: 100%;
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 12px 16px;
            color: var(--text-primary);
            font-size: 0.95rem;
            font-family: inherit;
            transition: border-color 0.3s;
        }

        .form-select:focus, .form-input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .form-select option {
            background: var(--bg-card);
        }

        .btn-generate {
            width: 100%;
            background: var(--accent);
            color: var(--bg-dark);
            border: none;
            padding: 16px;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
            transition: all 0.3s;
            font-family: 'Space Mono', monospace;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-generate:hover {
            background: var(--accent-dim);
            box-shadow: 0 0 30px rgba(0, 255, 136, 0.3);
        }

        .btn-generate:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Result Section */
        .result-section {
            display: none;
            margin-top: 30px;
        }

        .result-section.show {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .result-label {
            font-family: 'Space Mono', monospace;
            font-size: 0.8rem;
            color: var(--accent);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 12px;
        }

        .result-content {
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 24px;
            white-space: pre-wrap;
            line-height: 1.7;
            max-height: 400px;
            overflow-y: auto;
            font-size: 0.95rem;
        }

        .result-content::-webkit-scrollbar {
            width: 4px;
        }

        .result-content::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 4px;
        }

        /* Sources */
        .sources-section {
            margin-top: 24px;
        }

        .source-item {
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 18px;
            margin-bottom: 12px;
        }

        .source-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .source-name {
            font-weight: 600;
            color: var(--text-primary);
        }

        .relevance-badge {
            background: var(--accent);
            color: var(--bg-dark);
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            font-family: 'Space Mono', monospace;
        }

        .source-excerpt {
            font-size: 0.85rem;
            color: var(--text-secondary);
            font-style: italic;
            padding: 12px;
            background: rgba(0, 255, 136, 0.03);
            border-radius: 8px;
            border-left: 2px solid var(--accent-dim);
        }

        .source-reason {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 10px;
        }

        .meta-row {
            display: flex;
            gap: 24px;
            margin-top: 20px;
            padding-top: 16px;
            border-top: 1px solid var(--border);
            font-size: 0.85rem;
            color: var(--text-secondary);
            font-family: 'Space Mono', monospace;
        }

        /* Messages */
        .warning-box {
            background: rgba(255, 165, 2, 0.1);
            border: 1px solid var(--warning);
            color: var(--warning);
            padding: 14px 18px;
            border-radius: 10px;
            margin-bottom: 16px;
            font-size: 0.9rem;
        }

        .error-box {
            background: rgba(255, 71, 87, 0.1);
            border: 1px solid var(--danger);
            color: var(--danger);
            padding: 14px 18px;
            border-radius: 10px;
            margin-top: 16px;
            font-size: 0.9rem;
        }

        .loading-text {
            color: var(--text-muted);
            font-style: italic;
        }

        .loading-text::after {
            content: '';
            animation: dots 1.5s infinite;
        }

        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            padding: 16px 24px;
            border-radius: 10px;
            color: var(--bg-dark);
            font-weight: 600;
            z-index: 1000;
            animation: slideUp 0.4s ease;
        }

        .toast.success {
            background: var(--accent);
        }

        .toast.error {
            background: var(--danger);
            color: white;
        }

        @keyframes slideUp {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
            .form-row {
                grid-template-columns: 1fr;
            }
            .logo {
                font-size: 1.8rem;
            }
        }
    </style>
</head>
<body>
    <div class="app">
        <header class="header">
            <div class="logo">RAG<span>.</span>gen</div>
            <p class="tagline">AI-Powered Document Generation from Your Knowledge Base</p>
        </header>

        <div class="grid">
            <!-- Upload Card -->
            <div class="card">
                <div class="card-title">Upload Documents</div>
                <div class="upload-zone" id="uploadArea">
                    <div class="upload-icon">ðŸ“‚</div>
                    <p class="upload-text">Drop files here or click to browse</p>
                    <p class="upload-formats">.txt  .pdf  .docx</p>
                    <input type="file" id="fileInput" multiple accept=".txt,.pdf,.docx">
                </div>
            </div>

            <!-- Documents Card -->
            <div class="card">
                <div class="docs-header">
                    <div class="card-title" style="margin-bottom: 0;">Documents</div>
                    <button class="btn-icon" onclick="loadDocuments()">â†» Refresh</button>
                </div>
                <div class="doc-list" id="documentsList">
                    <div class="loading-text">Loading documents</div>
                </div>
            </div>
        </div>

        <!-- Generate Card -->
        <div class="card full-width">
            <div class="card-title">Generate Content</div>
            
            <div class="form-group">
                <label class="form-label">Your Query</label>
                <textarea class="form-textarea" id="query" placeholder="e.g., Create a FAQ about the remote work policy..."></textarea>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Generation Type</label>
                    <select class="form-select" id="genType">
                        <option value="general">General</option>
                        <option value="faq">FAQ</option>
                        <option value="summary">Summary</option>
                        <option value="blog">Blog Post</option>
                        <option value="report">Report</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Top K Results</label>
                    <input type="number" class="form-input" id="topK" placeholder="Default: 5" min="1" max="20">
                </div>
            </div>

            <button class="btn-generate" id="generateBtn" onclick="generateContent()">âš¡ Generate</button>

            <div class="result-section" id="resultSection">
                <div class="result-label">Generated Output</div>
                <div id="warningArea"></div>
                <div class="result-content" id="generatedContent"></div>
                
                <div class="sources-section">
                    <div class="result-label">Sources</div>
                    <div id="sourcesList"></div>
                </div>

                <div class="meta-row" id="metaInfo"></div>
            </div>

            <div id="errorArea"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000';

        document.addEventListener('DOMContentLoaded', () => {
            loadDocuments();
            setupDragDrop();
            setupFileInput();
        });

        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        async function loadDocuments() {
            const container = document.getElementById('documentsList');
            container.innerHTML = '<div class="loading-text">Loading documents</div>';

            try {
                const res = await fetch(`${API_BASE}/documents`);
                const data = await res.json();

                if (!res.ok) {
                    throw new Error(data.detail || 'Failed to load documents');
                }

                if (data.documents.length === 0) {
                    container.innerHTML = '<div class="empty-state">No documents yet</div>';
                    return;
                }

                container.innerHTML = data.documents.map(doc => `
                    <div class="doc-item">
                        <div>
                            <div class="doc-name">${doc.filename}</div>
                            <div class="doc-meta">${doc.total_chunks} chunks</div>
                            <div class="doc-id">${doc.document_id}</div>
                        </div>
                        <button class="btn-delete" onclick="deleteDocument('${doc.document_id}')">Delete</button>
                    </div>
                `).join('');
            } catch (e) {
                container.innerHTML = '<div class="empty-state">Failed to load</div>';
            }
        }

        async function deleteDocument(docId) {
            if (!confirm('Delete this document?')) return;

            try {
                const res = await fetch(`${API_BASE}/documents/${docId}`, { method: 'DELETE' });
                if (res.ok) {
                    showToast('Document deleted');
                    loadDocuments();
                } else {
                    showToast('Delete failed', 'error');
                }
            } catch (e) {
                showToast('Error deleting', 'error');
            }
        }

        function setupDragDrop() {
            const area = document.getElementById('uploadArea');

            area.addEventListener('dragover', (e) => {
                e.preventDefault();
                area.classList.add('dragover');
            });

            area.addEventListener('dragleave', () => {
                area.classList.remove('dragover');
            });

            area.addEventListener('drop', (e) => {
                e.preventDefault();
                area.classList.remove('dragover');
                if (e.dataTransfer.files.length) uploadFiles(e.dataTransfer.files);
            });

            area.addEventListener('click', () => {
                document.getElementById('fileInput').click();
            });
        }

        function setupFileInput() {
            document.getElementById('fileInput').addEventListener('change', (e) => {
                if (e.target.files.length) uploadFiles(e.target.files);
            });
        }

        async function uploadFiles(files) {
            const formData = new FormData();
            for (let file of files) {
                formData.append('files', file);
            }

            showToast('Uploading...');

            try {
                const res = await fetch(`${API_BASE}/upload`, {
                    method: 'POST',
                    body: formData
                });
                const data = await res.json();

                if (data.successful_uploads > 0) {
                    showToast(`${data.successful_uploads} file(s) uploaded`);
                }
                if (data.failed_uploads > 0) {
                    showToast(`${data.failed_uploads} failed`, 'error');
                }

                loadDocuments();
                document.getElementById('fileInput').value = '';
            } catch (e) {
                showToast('Upload failed', 'error');
            }
        }

        async function generateContent() {
            const query = document.getElementById('query').value.trim();
            if (!query) {
                showToast('Enter a query', 'error');
                return;
            }

            const genType = document.getElementById('genType').value;
            const topK = document.getElementById('topK').value;
            const btn = document.getElementById('generateBtn');

            const resultSection = document.getElementById('resultSection');
            const errorArea = document.getElementById('errorArea');
            
            resultSection.classList.remove('show');
            errorArea.innerHTML = '';
            btn.disabled = true;
            btn.textContent = 'Generating...';

            document.getElementById('generatedContent').innerHTML = '<span class="loading-text">Processing query</span>';
            resultSection.classList.add('show');

            const body = { query, generation_type: genType };
            if (topK) body.top_k = parseInt(topK);

            try {
                const res = await fetch(`${API_BASE}/generate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });

                const data = await res.json();

                if (!res.ok) {
                    throw new Error(data.detail || 'Generation failed');
                }

                const warningArea = document.getElementById('warningArea');
                warningArea.innerHTML = data.warning 
                    ? `<div class="warning-box">âš  ${data.warning}</div>` 
                    : '';

                document.getElementById('generatedContent').textContent = data.generated_content;

                const sourcesList = document.getElementById('sourcesList');
                if (data.sources.length === 0) {
                    sourcesList.innerHTML = '<div class="empty-state">No sources used</div>';
                } else {
                    sourcesList.innerHTML = data.sources.map(src => `
                        <div class="source-item">
                            <div class="source-header">
                                <span class="source-name">${src.filename}</span>
                                <span class="relevance-badge">${(src.relevance_score * 100).toFixed(0)}%</span>
                            </div>
                            <div class="source-excerpt">"${src.excerpt.substring(0, 200)}..."</div>
                            <div class="source-reason">${src.reason}</div>
                        </div>
                    `).join('');
                }

                document.getElementById('metaInfo').innerHTML = `
                    <span>DB Search: ${data.db_search_time}s</span>
                    <span>Sources: ${data.sources.length}</span>
                `;

            } catch (e) {
                resultSection.classList.remove('show');
                errorArea.innerHTML = `<div class="error-box">âœ• ${e.message}</div>`;
            } finally {
                btn.disabled = false;
                btn.textContent = 'âš¡ Generate';
            }
        }
    </script>
</body>
</html>
